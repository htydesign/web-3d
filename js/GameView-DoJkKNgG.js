var e=Object.defineProperty,i=(i,t,o)=>((i,t,o)=>t in i?e(i,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):i[t]=o)(i,"symbol"!=typeof t?t+"":t,o);import{B as t}from"./base-BaImv3YL.js";import{G as o,C as s,aF as n,aG as a,aH as r,P as h,M as l,b as c,B as v,S as d,X as m,Y as u,z as w,a5 as p,aL as f,aA as y}from"./three-CyihR34C.js";import{d as b,z as g,A as M,g as x,j as T,F as C,o as S}from"./@vue-DISYwsDo.js";import{_ as P}from"./index-Dd2VcruH.js";import"./pinia-DkR6u-JQ.js";import"./vue-router-kKGLm7zb.js";const U=P(b({__name:"GameView",setup(e){const b=new class extends t{constructor(){super(),i(this,"group",new o),i(this,"roadSize",{w:60,h:200}),i(this,"character"),i(this,"boxUnifor",{uTime:{value:0},uColor:{value:new s(16777215)}}),i(this,"obstacleMesh"),i(this,"isCollision",!1),i(this,"dispose",!1),i(this,"collisionColor",new s(16777215)),i(this,"isStart",!1),i(this,"sound"),i(this,"audioLoader",new n),i(this,"listener",new a),i(this,"obstacleConfig",{speed:5}),i(this,"keyMove",(e=>{if(!this.isStart)return!1;"a"!==e.key&&"A"!==e.key||-20==this.character.position.x?"d"!==e.key&&"D"!==e.key||20==this.character.position.x||(this.character.position.x+=20):this.character.position.x-=20}))}load(){this.init("#webgl"),this.animate(),this.gridHelper(),this.createRoad(),this.createCharacter(),this.createObstacle(),this.collisionAudio()}collisionAudio(){this.sound=new r(this.listener),this.audioLoader.load("./music/pengzhuang.wav",(e=>{var i;null==(i=this.sound)||i.setBuffer(e)}))}createRoad(){var e;const i=new h(this.roadSize.w,this.roadSize.h),t=new l({color:16777215,opacity:.5,transparent:!0}),o=new c(i,t),s=new y;s.makeRotationX(-Math.PI/2).setPosition(0,0,-this.roadSize.w),o.applyMatrix4(s),null==(e=this.scene)||e.add(o)}createCharacter(){var e,i;const t=new h(this.roadSize.w,10),o=new l({color:16777215}),s=new c(t,o);s.position.set(0,0,5-(this.roadSize.w-this.roadSize.h/2)),s.rotateX(-Math.PI/2),null==(e=this.scene)||e.add(s),this.character=new c(new v(5,10,5),new l({color:65280})),this.character.position.set(0,5,5-(this.roadSize.w-this.roadSize.h/2)),null==(i=this.scene)||i.add(this.character),this.createCircle()}createCircle(){var e,i,t,o;const s=new h(8,8),n=new d({opacity:0,transparent:!0,uniforms:this.boxUnifor,vertexShader:"\n        uniform float uTime;\n        varying vec2 vUv;\n        varying float vTime;\n        void main() {\n            vUv = uv;\n            vTime = uTime>0.5?1.0-uTime:uTime;\n            vec4 newPosition =  vec4(position, 1.0);\n            newPosition.xy *= uTime * 3.0;\n            gl_Position = projectionMatrix * modelViewMatrix * newPosition;\n\n        }\n",fragmentShader:"\n        uniform vec3 uColor;\n        varying float vTime;\n        varying vec2 vUv;\n        void main() {\n            float alpha = smoothstep(1.0, 0.1, vUv.y) * vTime;\n            gl_FragColor = vec4(uColor, alpha);\n        }\n      "}),a=new c(s,n);a.rotateX(-Math.PI/2),a.position.set(0,-4.9,0),a.name="circle",null==(e=this.character)||e.add(a);const r=new d({opacity:0,transparent:!0,uniforms:this.boxUnifor,vertexShader:"\n        uniform float uTime;\n        varying vec2 vUv;\n        varying float vTime;\n        void main() {\n            vUv = uv;\n            vTime = uTime>0.5?1.0-uTime:uTime;\n            vec4 newPosition =  vec4(position, 1.0);\n            newPosition.xy *= uTime * 3.0;\n            gl_Position = projectionMatrix * modelViewMatrix * newPosition;\n\n        }\n",fragmentShader:"\n        uniform float uTime;\n        varying vec2 vUv;\n        uniform vec3 uColor;\n        void main() {\n            float alpha = smoothstep(1.0, 0.0, uTime);\n            gl_FragColor = vec4(uColor, alpha);\n        }\n      "}),l=new m(s),p=new u(l,r);p.rotateX(-Math.PI/2),p.position.set(0,-4.9,0),p.name="circleLine",null==(i=this.character)||i.add(p);const f=new v(8,20,8),y=new d({opacity:0,transparent:!0,wireframe:!1,uniforms:this.boxUnifor,vertexShader:"\n        uniform float uTime;\n        varying vec2 vUv;\n        varying float vTime;\n        void main() {\n            vUv = uv;\n            vTime = uTime>0.5?1.0-uTime:uTime;\n            vec4 newPosition = modelMatrix * vec4(position, 1.0);\n            newPosition.y *= uTime;\n           gl_Position = projectionMatrix * viewMatrix * newPosition;\n        }\n      ",fragmentShader:"\n        uniform vec3 uColor;\n        varying float vTime;\n        varying vec2 vUv;\n        void main() {\n            float alpha = smoothstep(1.0, 0.1, vUv.y) * vTime;\n            gl_FragColor = vec4(uColor, alpha);\n        }\n      "}),b=new c(f,y);b.position.set(0,5.1,0),b.name="box",null==(t=this.character)||t.add(b);const g=new w({color:16777215,opacity:0,transparent:!0}),M=new m(f),x=new u(M,g);x.name="boxLine",x.position.set(0,5.1,0),null==(o=this.character)||o.add(x)}showMesh(e,i=.5){if(this.character){const t=this.character.getObjectByName(e).material;new p.Tween(t).to({opacity:i},200).start().chain(new p.Tween(t).to({opacity:0},200)).yoyo(!1).onUpdate(((i,t)=>{"boxLine"===e&&(this.boxUnifor.uTime.value=t)}))}}createObstacle(){var e;this.isCollision=!1;const i=[-20,0,20],t=i[Math.floor(Math.random()*i.length)];this.collisionColor=new s(Math.random(),Math.random(),Math.random()),this.boxUnifor.uColor.value=this.collisionColor,this.obstacleConfig.speed=5*Math.random()+5;const o=new h(10,20),n=new l({color:this.collisionColor});this.obstacleMesh=new c(o,n),this.obstacleMesh.rotateX(-Math.PI/2),this.obstacleMesh.position.set(t,.1,-200),null==(e=this.scene)||e.add(this.obstacleMesh)}destroy(){var e;null==(e=this.scene)||e.remove(this.obstacleMesh)}collisionDetection(){var e,i;if(this.character&&this.obstacleMesh){const t=(new f).setFromObject(this.character),o=(new f).setFromObject(this.obstacleMesh);t.intersectsBox(o)&&!this.isCollision&&(this.isCollision=!0,this.character.material.color=this.collisionColor,null==(e=this.sound)||e.stop(),null==(i=this.sound)||i.play(),this.showMesh("circleLine",1),this.showMesh("boxLine"))}}animate(){var e,i;this.dispose||(null==(e=this.stats)||e.begin(),p.update(),requestAnimationFrame((()=>{this.animate()})),this.renderer&&this.renderer.render(this.scene,this.camera),this.obstacleMesh&&this.isStart&&(this.obstacleMesh.position.z+=this.obstacleConfig.speed,this.collisionDetection(),this.obstacleMesh.position.z>-(this.roadSize.w-this.roadSize.h/2)&&(this.destroy(),this.createObstacle())),null==(i=this.stats)||i.end())}};return g((()=>{b.load(),window.addEventListener("keydown",b.keyMove),window.addEventListener("click",(()=>{b.isStart=!0}))})),M((()=>{b.destroy(),b.dispose=!0,window.removeEventListener("keydown",b.keyMove),b.isStart=!1})),(e,i)=>(S(),x(C,null,[i[0]||(i[0]=T("div",{id:"webgl"},null,-1)),i[1]||(i[1]=T("div",{class:"title-name"},"game",-1)),i[2]||(i[2]=T("div",{class:"hint"},"点击平面开始(按 A,D 移动)",-1))],64))}}),[["__scopeId","data-v-7fd667a6"]]);export{U as default};
