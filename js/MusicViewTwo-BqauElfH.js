var e=Object.defineProperty,t=(t,i,s)=>((t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s)(t,"symbol"!=typeof i?i+"":i,s);import{B as i}from"./base-HDikCi6F.js";import{d as s,r as n,g as a,j as r,k as o,l,H as d,y as u,t as c,F as h,o as v}from"./@vue-H0c_gk4m.js";import{G as m,aG as p,aH as f,I as y,P as g,M as w,D as x,O as b,j as M,S as T,A as j,b as C,a as U,aI as P,aJ as _}from"./three-BHpSmIVb.js";import{_ as k}from"./index-DcliGhKH.js";import"./pinia-DiTk8w0t.js";import"./vue-router-DusXlGQI.js";const A={key:1,class:"progress"},S=k(s({__name:"MusicViewTwo",setup(e){const s=n(!1),k=n(""),S=n(!0);const z=new class extends i{constructor(){super(),t(this,"box"),t(this,"planeGroup",new m),t(this,"sound"),t(this,"audioLoader",new p),t(this,"listener",new f),t(this,"analyser"),t(this,"fftSize",128),t(this,"cylinder"),t(this,"topVertices",[]),t(this,"uniforms",{uTime:{value:0}})}load(){this.renderer.localClippingEnabled=!0,this.init("#webgl"),this.animate(),this.gridHelper(),this.createRound()}createRound(){const e=this.fftSize/2,t=new y(new g(1,20),new w({color:16777215,side:x}),e);t.instanceMatrix.needsUpdate=!0;const i=new b;for(let s=0;s<e;s++){const n=100*Math.cos(s*(Math.PI/180)*(360/e)),a=100*Math.sin(s*(Math.PI/180)*(360/e));i.position.set(n,0,a),i.lookAt(0,0,0),i.updateMatrix(),t.setMatrixAt(s,i.matrix)}this.createCylinder(e,100,20)}createCylinder(e,t,i){var s;const n=new M(t,t,i,e,1,!0),a=new T({side:x,transparent:!0,wireframe:!1,depthTest:!1,blending:j,uniforms:this.uniforms,vertexShader:"\n        uniform float uTime;\n\n        varying float vTime;\n\n        varying vec2 vUv;\n\n        void main() {\n          vTime = uTime;\n          vUv = uv;\n          vec3 newPosition = position;\n\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);\n        }\n      ",fragmentShader:"\n        uniform float uTime;\n        varying float vTime;\n        varying vec2 vUv;\n\n        void main() {\n         //渐变色\n          vec3 finalColor = vec3(1.0,1.0,1.0);      \n          if(vUv.x > 0.5){\n            finalColor = mix(vec3(1.0,0.0,1.0), vec3(1.0,1.0,0.0), vUv.x); \n          }else{\n            finalColor = mix(vec3(1.0,1.0,0.0), vec3(1.0,0.0,1.0), vUv.x);\n          }\n          \n\n          float alpha = smoothstep(0.0, 1.0, vUv.y);\n\n          if(uTime<vUv.x){\n            discard;\n          }\n\n          gl_FragColor = vec4(finalColor, alpha);\n        }\n      "});this.cylinder=new C(n,a);const r=this.cylinder.geometry.attributes.position;for(let o=0;o<r.count;o++){const e=r.array[3*o+1],t=r.array[3*o+0],i=r.array[3*o+2];e>0&&this.topVertices.push({index:o,vertice:new U(t,e,i)})}null==(s=this.scene)||s.add(this.cylinder),this.gui.add(a,"wireframe").onChange((e=>{a.wireframe=e}))}getAudio(){this.sound=new P(this.listener),this.audioLoader.load("./music/xiaomeiman.mp3",(e=>{var t,i;null==(t=this.sound)||t.setBuffer(e),null==(i=this.sound)||i.play()}),(e=>{k.value=(e.loaded/e.total*100).toFixed(2)+"%",this.uniforms.uTime.value=e.loaded/e.total,e.loaded===e.total&&(S.value=!0)})),this.analyser=new _(this.sound,this.fftSize)}updatePosition(e){if(!this.cylinder)return!1;const t=this.cylinder.geometry.attributes.position,i=[],s=[],n=[];for(let r=0;r<e.length;r++)r<e.length/2?s.push(e[r]):n.push(e[r-e.length/2]);i.push(...s,...n.reverse()),i.push(e[0]);const a=this.topVertices.map(((e,t)=>({index:e.index,vertice:new U(e.vertice.x,i[t]/2,e.vertice.z)})));for(let r=0;r<i.length;r++)t.setXYZ(a[r].index,a[r].vertice.x,a[r].vertice.y,a[r].vertice.z);t.needsUpdate=!0}destroy(){var e;null==(e=this.sound)||e.stop()}animate(){var e,t;null==(e=this.stats)||e.begin(),this.timer=requestAnimationFrame((()=>{this.animate()})),this.renderer.render(this.scene,this.camera),this.analyser&&(this.analyser.getFrequencyData(),this.updatePosition(this.analyser.data)),null==(t=this.stats)||t.end()}},F=()=>{s.value=!0,S.value=!1,z.getAudio()};return a((()=>{z.load()})),r((()=>{z.destroy()})),(e,t)=>(v(),o(h,null,[t[0]||(t[0]=l("div",{id:"webgl"},null,-1)),t[1]||(t[1]=l("div",{class:"title-name"},"music2",-1)),s.value?u("",!0):(v(),o("div",{key:0,class:d(["measure"]),onClick:F}," click play music ")),S.value?u("",!0):(v(),o("div",A," 正在加载...（"+c(k.value)+"） ",1))],64))}}),[["__scopeId","data-v-3430b1d4"]]);export{S as default};
