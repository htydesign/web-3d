var e=Object.defineProperty,i=(i,t,o)=>((i,t,o)=>t in i?e(i,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):i[t]=o)(i,"symbol"!=typeof t?t+"":t,o);import{B as t}from"./base-Bvp4kbhh.js";import{G as o,C as n,x as s,M as a,b as r,N as h,g as c,u as l,E as v,L as m,c as d,e as u,a5 as w}from"./three-BQi6w2h5.js";import{d as p,z as f,A as y,g as b,j as g,F as M,o as x}from"./@vue-B4sUqkWa.js";import{_ as T}from"./index-BnPjy11b.js";import"./pinia-C4SihLJg.js";import"./vue-router-CANWKAPm.js";const C=T(p({__name:"GameView",setup(e){const p=new class extends t{constructor(){super(),i(this,"group",new o),i(this,"roadSize",{w:60,h:200}),i(this,"character"),i(this,"boxUnifor",{uTime:{value:0},uColor:{value:new n(16777215)}}),i(this,"obstacleMesh"),i(this,"isCollision",!1),i(this,"dispose",!1),i(this,"collisionColor",new n(16777215)),i(this,"isStart",!1),i(this,"keyMove",(e=>{if(!this.isStart)return!1;"a"!==e.key&&"A"!==e.key||-20==this.character.position.x?"d"!==e.key&&"D"!==e.key||20==this.character.position.x||(this.character.position.x+=20):this.character.position.x-=20}))}load(){this.init("#webgl"),this.animate(),this.gridHelper(),this.createRoad(),this.createCharacter(),this.createObstacle()}createRoad(){var e;const i=new s(this.roadSize.w,this.roadSize.h),t=new a({color:16777215,opacity:.5,transparent:!0}),o=new r(i,t),n=new h;n.makeRotationX(-Math.PI/2).setPosition(0,0,-this.roadSize.w),o.applyMatrix4(n),null==(e=this.scene)||e.add(o)}createCharacter(){var e,i;const t=new s(this.roadSize.w,10),o=new a({color:16777215}),n=new r(t,o);n.position.set(0,0,5-(this.roadSize.w-this.roadSize.h/2)),n.rotateX(-Math.PI/2),null==(e=this.scene)||e.add(n),this.character=new r(new c(5,10,5),new a({color:65280})),this.character.position.set(0,5,5-(this.roadSize.w-this.roadSize.h/2)),null==(i=this.scene)||i.add(this.character),this.createCircle()}createCircle(){var e,i,t,o;const n=new s(8,8),a=new l({opacity:0,transparent:!0,uniforms:this.boxUnifor,vertexShader:"\n        uniform float uTime;\n        varying vec2 vUv;\n        varying float vTime;\n        void main() {\n            vUv = uv;\n            vTime = uTime>0.5?1.0-uTime:uTime;\n            vec4 newPosition =  vec4(position, 1.0);\n            newPosition.xy *= uTime * 3.0;\n            gl_Position = projectionMatrix * modelViewMatrix * newPosition;\n\n        }\n",fragmentShader:"\n        uniform vec3 uColor;\n        varying float vTime;\n        varying vec2 vUv;\n        void main() {\n            float alpha = smoothstep(1.0, 0.1, vUv.y) * vTime;\n            gl_FragColor = vec4(uColor, alpha);\n        }\n      "}),h=new r(n,a);h.rotateX(-Math.PI/2),h.position.set(0,-4.9,0),h.name="circle",null==(e=this.character)||e.add(h);const u=new l({opacity:0,transparent:!0,uniforms:this.boxUnifor,vertexShader:"\n        uniform float uTime;\n        varying vec2 vUv;\n        varying float vTime;\n        void main() {\n            vUv = uv;\n            vTime = uTime>0.5?1.0-uTime:uTime;\n            vec4 newPosition =  vec4(position, 1.0);\n            newPosition.xy *= uTime * 3.0;\n            gl_Position = projectionMatrix * modelViewMatrix * newPosition;\n\n        }\n",fragmentShader:"\n        uniform float uTime;\n        varying vec2 vUv;\n        uniform vec3 uColor;\n        void main() {\n            float alpha = smoothstep(1.0, 0.0, uTime);\n            gl_FragColor = vec4(uColor, alpha);\n        }\n      "}),w=new v(n),p=new m(w,u);p.rotateX(-Math.PI/2),p.position.set(0,-4.9,0),p.name="circleLine",null==(i=this.character)||i.add(p);const f=new c(8,20,8),y=new l({opacity:0,transparent:!0,wireframe:!1,uniforms:this.boxUnifor,vertexShader:"\n        uniform float uTime;\n        varying vec2 vUv;\n        varying float vTime;\n        void main() {\n            vUv = uv;\n            vTime = uTime>0.5?1.0-uTime:uTime;\n            vec4 newPosition = modelMatrix * vec4(position, 1.0);\n            newPosition.y *= uTime;\n           gl_Position = projectionMatrix * viewMatrix * newPosition;\n        }\n      ",fragmentShader:"\n        uniform vec3 uColor;\n        varying float vTime;\n        varying vec2 vUv;\n        void main() {\n            float alpha = smoothstep(1.0, 0.1, vUv.y) * vTime;\n            gl_FragColor = vec4(uColor, alpha);\n        }\n      "}),b=new r(f,y);b.position.set(0,5.1,0),b.name="box",null==(t=this.character)||t.add(b);const g=new d({color:16777215,opacity:0,transparent:!0}),M=new v(f),x=new m(M,g);x.name="boxLine",x.position.set(0,5.1,0),null==(o=this.character)||o.add(x)}showMesh(e,i=.5){if(this.character){const t=this.character.getObjectByName(e).material;new u.Tween(t).to({opacity:i},200).start().chain(new u.Tween(t).to({opacity:0},200)).yoyo(!1).onUpdate(((i,t)=>{"boxLine"===e&&(this.boxUnifor.uTime.value=t)}))}}createObstacle(){var e;this.isCollision=!1;const i=[-20,0,20],t=i[Math.floor(Math.random()*i.length)];this.collisionColor=new n(Math.random(),Math.random(),Math.random()),this.boxUnifor.uColor.value=this.collisionColor;const o=new s(10,20),h=new a({color:this.collisionColor});this.obstacleMesh=new r(o,h),this.obstacleMesh.rotateX(-Math.PI/2),this.obstacleMesh.position.set(t,.1,-200),null==(e=this.scene)||e.add(this.obstacleMesh)}destroy(){var e;null==(e=this.scene)||e.remove(this.obstacleMesh)}collisionDetection(){if(this.character&&this.obstacleMesh){const e=(new w).setFromObject(this.character),i=(new w).setFromObject(this.obstacleMesh);e.intersectsBox(i)&&!this.isCollision&&(this.isCollision=!0,this.character.material.color=this.collisionColor,this.showMesh("circleLine",1),this.showMesh("boxLine"))}}animate(){var e,i;this.dispose||(null==(e=this.stats)||e.begin(),u.update(),requestAnimationFrame((()=>{this.animate()})),this.renderer&&this.renderer.render(this.scene,this.camera),this.obstacleMesh&&this.isStart&&(this.obstacleMesh.position.z+=5,this.collisionDetection(),this.obstacleMesh.position.z>-(this.roadSize.w-this.roadSize.h/2)&&(this.destroy(),this.createObstacle())),null==(i=this.stats)||i.end())}};return f((()=>{p.load(),window.addEventListener("keydown",p.keyMove),window.addEventListener("click",(()=>{p.isStart=!0}))})),y((()=>{var e,i;p.gui.close(),p.gui.destroy(),p.destroy(),null==(e=p.renderer)||e.dispose(),null==(i=p.scene)||i.children.forEach((e=>{var i;null==(i=p.scene)||i.remove(e)})),p.dispose=!0,window.removeEventListener("keydown",p.keyMove),p.isStart=!1})),(e,i)=>(x(),b(M,null,[i[0]||(i[0]=g("div",{id:"webgl"},null,-1)),i[1]||(i[1]=g("div",{class:"title-name"},"game",-1)),i[2]||(i[2]=g("div",{class:"hint"},"点击平面开始(按 A,D 移动)",-1))],64))}}),[["__scopeId","data-v-a68386b9"]]);export{C as default};
